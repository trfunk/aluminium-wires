import numpy as np
import math
from ansys.mapdl import core as pymapdl
import matplotlib.pyplot as plt

mapdl = pymapdl.launch_mapdl(jobname="axial_compression",
                             run_location=r"C:\Users\Tristan\Nextcloud Uni\masterarbeit\tfunk_apdl\axial_compression\results")

mapdl.units("uMKS")
mapdl.prep7()

# Define the base area of the cylinder and extrude it by dz
circle = mapdl.cyl4(0, 0, rad1=0.5)
cylinder = mapdl.vext(circle, dz=1)
mapdl.et(1, "SOLID187")
mapdl.esize(0.1)
mapdl.vmesh(1)

# material
mapdl.mp("EX", 1, 70000)
mapdl.mp("NUXY", 1, 0.33)
mapdl.tb("PLASTIC", 1, 0, 100, "MISO")
mapdl.tbtemp(0)
mapdl.tbpt("DEFI", 0., 35)
mapdl.tbpt("DEFI", 0.006404, 38.462422)
mapdl.tbpt("DEFI", 0.013391, 40.771305)
mapdl.tbpt("DEFI", 0.020449, 42.795692)
mapdl.tbpt("DEFI", 0.027549, 44.596772)
mapdl.tbpt("DEFI", 0.034639, 46.287318)
mapdl.tbpt("DEFI", 0.041718, 47.871270)
mapdl.tbpt("DEFI", 0.048773, 49.378790)
mapdl.tbpt("DEFI", 0.055794, 50.831651)
mapdl.tbpt("DEFI", 0.062771, 52.251727)
mapdl.tbpt("DEFI", 0.069709, 53.632774)
mapdl.tbpt("DEFI", 0.076610, 54.970229)
mapdl.tbpt("DEFI", 0.083464, 56.289894)
mapdl.tbpt("DEFI", 0.090277, 57.577289)
mapdl.tbpt("DEFI", 0.097038, 58.859553)
mapdl.tbpt("DEFI", 0.103755, 60.121222)
mapdl.tbpt("DEFI", 0.110429, 61.361107)
mapdl.tbpt("DEFI", 0.117048, 62.604922)
mapdl.tbpt("DEFI", 0.123621, 63.838344)
mapdl.tbpt("DEFI", 0.130152, 65.054693)
mapdl.tbpt("DEFI", 0.136643, 66.246554)
mapdl.tbpt("DEFI", 0.143093, 67.423803)
mapdl.tbpt("DEFI", 0.149492, 68.603965)
mapdl.tbpt("DEFI", 0.155846, 69.776590)
mapdl.tbpt("DEFI", 0.162161, 70.931980)
mapdl.tbpt("DEFI", 0.168439, 72.068351)
mapdl.tbpt("DEFI", 0.174674, 73.196973)
mapdl.tbpt("DEFI", 0.180862, 74.328196)
mapdl.tbpt("DEFI", 0.187015, 75.438768)
mapdl.tbpt("DEFI", 0.193127, 76.542690)
mapdl.tbpt("DEFI", 0.199203, 77.630599)
mapdl.tbpt("DEFI", 0.205238, 78.712745)
mapdl.tbpt("DEFI", 0.211238, 79.780295)
mapdl.tbpt("DEFI", 0.217202, 80.833593)
mapdl.tbpt("DEFI", 0.223125, 81.886439)
mapdl.tbpt("DEFI", 0.229019, 82.913977)
mapdl.tbpt("DEFI", 0.234871, 83.943346)
mapdl.tbpt("DEFI", 0.240687, 84.966302)
mapdl.tbpt("DEFI", 0.246467, 85.981031)
mapdl.tbpt("DEFI", 0.252208, 86.996040)
mapdl.tbpt("DEFI", 0.257919, 87.994597)
mapdl.tbpt("DEFI", 0.263595, 88.984969)
mapdl.tbpt("DEFI", 0.269239, 89.964668)
mapdl.tbpt("DEFI", 0.274851, 90.933061)
mapdl.tbpt("DEFI", 0.280427, 91.899036)
mapdl.tbpt("DEFI", 0.285974, 92.851221)
mapdl.tbpt("DEFI", 0.291492, 93.789892)
mapdl.tbpt("DEFI", 0.296974, 94.727310)
mapdl.tbpt("DEFI", 0.302422, 95.664688)
mapdl.tbpt("DEFI", 0.307843, 96.585484)
mapdl.tbpt("DEFI", 0.313227, 97.513530)
mapdl.tbpt("DEFI", 0.318584, 98.426031)
mapdl.tbpt("DEFI", 0.323911, 99.332668)
mapdl.tbpt("DEFI", 0.329202, 100.24481)
mapdl.tbpt("DEFI", 0.334463, 101.150199)
mapdl.tbpt("DEFI", 0.339698, 102.043971)
mapdl.tbpt("DEFI", 0.344905, 102.929525)
mapdl.tbpt("DEFI", 0.350078, 103.820749)
mapdl.tbpt("DEFI", 0.355227, 104.696795)
mapdl.tbpt("DEFI", 0.360336, 105.591494)
mapdl.tbpt("DEFI", 0.365420, 106.475140)
mapdl.tbpt("DEFI", 0.370470, 107.366688)
mapdl.tbpt("DEFI", 0.375499, 108.241226)
mapdl.tbpt("DEFI", 0.380497, 109.116365)
mapdl.tbpt("DEFI", 0.385464, 109.996218)
mapdl.tbpt("DEFI", 0.390407, 110.866325)
mapdl.tbpt("DEFI", 0.395327, 111.725823)
mapdl.tbpt("DEFI", 0.400213, 112.596446)
mapdl.tbpt("DEFI", 0.405064, 113.481506)
mapdl.tbpt("DEFI", 0.409900, 114.339774)
mapdl.tbpt("DEFI", 0.414707, 115.200359)
mapdl.tbpt("DEFI", 0.419483, 116.070796)
mapdl.tbpt("DEFI", 0.424238, 116.930321)
mapdl.tbpt("DEFI", 0.428973, 117.774210)
mapdl.tbpt("DEFI", 0.433688, 118.604393)
mapdl.tbpt("DEFI", 0.438374, 119.442430)
mapdl.tbpt("DEFI", 0.443020, 120.309025)
mapdl.tbpt("DEFI", 0.447653, 121.152073)
mapdl.tbpt("DEFI", 0.452252, 122.010357)
mapdl.tbpt("DEFI", 0.456839, 122.843514)
mapdl.tbpt("DEFI", 0.461400, 123.678752)
mapdl.tbpt("DEFI", 0.465921, 124.546290)
mapdl.tbpt("DEFI", 0.470442, 125.363433)
mapdl.tbpt("DEFI", 0.474932, 126.194275)
mapdl.tbpt("DEFI", 0.479386, 127.051936)
mapdl.tbpt("DEFI", 0.483829, 127.883031)
mapdl.tbpt("DEFI", 0.488241, 128.731053)
mapdl.tbpt("DEFI", 0.492641, 129.554299)
mapdl.tbpt("DEFI", 0.497030, 130.352527)
mapdl.tbpt("DEFI", 0.501376, 131.195320)
mapdl.tbpt("DEFI", 0.505716, 132.002819)
mapdl.tbpt("DEFI", 0.510026, 132.826333)
mapdl.tbpt("DEFI", 0.514332, 133.612357)
mapdl.tbpt("DEFI", 0.518613, 134.404574)
mapdl.tbpt("DEFI", 0.522869, 135.204766)
mapdl.tbpt("DEFI", 0.527107, 135.995579)
mapdl.tbpt("DEFI", 0.531330, 136.776426)
mapdl.tbpt("DEFI", 0.535531, 137.557760)
mapdl.tbpt("DEFI", 0.539705, 138.352014)
mapdl.tbpt("DEFI", 0.543879, 139.146268)
mapdl.tbpt("DEFI", 0.548053, 139.940522)
mapdl.tbpt("DEFI", 0.552227, 140.734776)
mapdl.tbpt("DEFI", 0.556401, 141.529030)
mapdl.tbpt("DEFI", 0.560575, 142.323284)
mapdl.tbpt("DEFI", 0.564749, 143.117538)
mapdl.tbpt("DEFI", 0.568923, 143.911792)
mapdl.tbpt("DEFI", 0.573097, 144.706046)
mapdl.tbpt("DEFI", 0.577271, 145.500300)
mapdl.tbpt("DEFI", 0.581445, 146.294554)
mapdl.tbpt("DEFI", 0.585619, 147.088808)
mapdl.tbpt("DEFI", 0.589793, 147.883062)
mapdl.tbpt("DEFI", 0.593967, 148.677316)
mapdl.tbpt("DEFI", 0.598141, 149.471570)
mapdl.tbpt("DEFI", 0.602315, 150.265824)
mapdl.tbpt("DEFI", 0.606489, 151.060078)
mapdl.tbpt("DEFI", 0.610663, 151.854332)
mapdl.tbpt("DEFI", 0.614837, 152.648586)
mapdl.tbpt("DEFI", 0.619011, 153.442840)
mapdl.tbpt("DEFI", 0.623185, 154.237094)
mapdl.tbpt("DEFI", 0.627359, 155.031348)
mapdl.tbpt("DEFI", 0.631533, 155.825602)
mapdl.tbpt("DEFI", 0.635707, 156.619856)
mapdl.tbpt("DEFI", 0.639881, 157.414110)
mapdl.tbpt("DEFI", 0.644055, 158.208364)
mapdl.tbpt("DEFI", 0.648229, 159.002618)
mapdl.tbpt("DEFI", 0.652403, 159.796872)
mapdl.tbpt("DEFI", 0.656577, 160.591126)
mapdl.tbpt("DEFI", 0.660751, 161.385380)
mapdl.tbpt("DEFI", 0.664925, 162.179634)
mapdl.tbpt("DEFI", 0.669099, 162.973888)
mapdl.tbpt("DEFI", 0.673273, 163.768142)
mapdl.tbpt("DEFI", 0.677447, 164.562396)
mapdl.tbpt("DEFI", 0.681621, 165.356650)
mapdl.tbpt("DEFI", 0.685795, 166.150904)
mapdl.tbpt("DEFI", 0.689969, 166.945158)
mapdl.tbpt("DEFI", 0.694143, 167.739412)
mapdl.tbpt("DEFI", 0.698317, 168.533666)
mapdl.tbpt("DEFI", 0.702491, 169.327920)
mapdl.tbpt("DEFI", 0.706665, 170.122174)
mapdl.tbpt("DEFI", 0.710839, 170.916428)
mapdl.tbpt("DEFI", 0.715013, 171.710682)
mapdl.tbpt("DEFI", 0.719187, 172.504936)
mapdl.tbpt("DEFI", 0.723361, 173.299190)
mapdl.tbpt("DEFI", 0.727535, 174.093444)
mapdl.tbpt("DEFI", 0.731709, 174.887698)
mapdl.tbpt("DEFI", 0.735883, 175.681952)
mapdl.tbpt("DEFI", 0.740057, 176.476206)
mapdl.tbpt("DEFI", 0.744231, 177.270460)
mapdl.tbpt("DEFI", 0.748405, 178.064714)
mapdl.tbpt("DEFI", 0.752579, 178.858968)
mapdl.tbpt("DEFI", 0.756753, 179.653222)
mapdl.tbpt("DEFI", 0.760927, 180.447476)
mapdl.tbpt("DEFI", 0.765101, 181.241730)
mapdl.tbpt("DEFI", 0.769275, 182.035984)
mapdl.tbpt("DEFI", 0.773449, 182.830238)
mapdl.tbpt("DEFI", 0.777623, 183.624492)
mapdl.tbpt("DEFI", 0.781797, 184.418746)
mapdl.tbpt("DEFI", 0.785971, 185.213000)
mapdl.tbpt("DEFI", 0.790145, 186.007254)
mapdl.tbpt("DEFI", 0.794319, 186.801508)
mapdl.tbpt("DEFI", 0.798493, 187.595762)
mapdl.tbpt("DEFI", 0.802667, 188.390016)
mapdl.tbpt("DEFI", 0.806841, 189.184270)
mapdl.tbpt("DEFI", 0.811015, 189.978524)
mapdl.tbpt("DEFI", 0.815189, 190.772778)
mapdl.tbpt("DEFI", 0.819363, 191.567032)
mapdl.tbpt("DEFI", 0.823537, 192.361286)
mapdl.tbpt("DEFI", 0.827711, 193.155540)
mapdl.tbpt("DEFI", 0.831885, 193.949794)
mapdl.tbpt("DEFI", 0.836059, 194.744048)
mapdl.tbpt("DEFI", 0.840233, 195.538302)
mapdl.tbpt("DEFI", 0.844407, 196.332556)
mapdl.tbpt("DEFI", 0.848581, 197.126810)
mapdl.tbpt("DEFI", 0.852755, 197.921064)
mapdl.tbpt("DEFI", 0.856929, 198.715318)
mapdl.tbpt("DEFI", 0.861103, 199.509572)
mapdl.tbpt("DEFI", 0.865277, 200.303826)
mapdl.tbpt("DEFI", 0.869451, 201.098080)
mapdl.tbpt("DEFI", 0.873625, 201.892334)
mapdl.tbpt("DEFI", 0.877799, 202.686588)
mapdl.tbpt("DEFI", 0.881973, 203.480842)
mapdl.tbpt("DEFI", 0.886147, 204.275096)
mapdl.tbpt("DEFI", 0.890321, 205.069350)
mapdl.tbpt("DEFI", 0.894495, 205.863604)
mapdl.tbpt("DEFI", 0.898669, 206.657858)
mapdl.tbpt("DEFI", 0.902843, 207.452112)
mapdl.tbpt("DEFI", 0.907017, 208.246366)
mapdl.tbpt("DEFI", 0.911191, 209.040620)
mapdl.tbpt("DEFI", 0.915365, 209.834874)
mapdl.tbpt("DEFI", 0.919539, 210.629128)
mapdl.tbpt("DEFI", 0.923713, 211.423382)
mapdl.tbpt("DEFI", 0.927887, 212.217636)
mapdl.tbpt("DEFI", 0.932061, 213.011890)
mapdl.tbpt("DEFI", 0.936235, 213.806144)
mapdl.tbpt("DEFI", 0.940409, 214.600398)
mapdl.tbpt("DEFI", 0.944583, 215.394652)
mapdl.tbpt("DEFI", 0.948757, 216.188906)
mapdl.tbpt("DEFI", 0.952931, 216.983160)
mapdl.tbpt("DEFI", 0.957105, 217.777414)
mapdl.tbpt("DEFI", 0.961279, 218.571668)
mapdl.tbpt("DEFI", 0.965453, 219.365922)
mapdl.tbpt("DEFI", 0.969627, 220.160176)
mapdl.tbpt("DEFI", 0.973801, 220.954430)
mapdl.tbpt("DEFI", 0.977975, 221.748684)
mapdl.tbpt("DEFI", 0.982149, 222.542938)
mapdl.tbpt("DEFI", 0.986323, 223.337192)


# uncomment for anisotropic behaviour
mapdl.tb("HILL", 1)
mapdl.tbdata(1, 0.6, 0.6, 1.0, 0.7, 0.7, 0.5)

# target plate
mapdl.real(1)
mapdl.n(100001, -1, -1, 1.0001)
mapdl.n(100002, 1, -1, 1.0001)
mapdl.n(100003, 1, 1, 1.0001)
mapdl.n(100004, -1, 1, 1.0001)
mapdl.et(2, 170)
mapdl.type(2)
mapdl.tshap("QUAD")

# Order is important, normal has to face cylinder. Doing 100001 -> 1000004 causes the normal to point away from the cylinder, causing penetration
target = mapdl.e(100004, 100003, 100002, 100001)

# contact on A2 - A6
mapdl.et(3, 174)
mapdl.type(3)
mapdl.asel("S", "AREA", vmin=2, vmax=6, vinc=1)
mapdl.nsla("S", 1)
mapdl.esurf()
mapdl.allsel()

# constraints cylinder
mapdl.asel("S", vmin=1)
mapdl.nsla("S", 1)
mapdl.dsym("SYMM", "Z")
mapdl.allsel()
mapdl.d(88, "UX", 0)
mapdl.d(88, "UY", 0)
mapdl.d(55, "UY", 0)

# constraints target
mapdl.nsel("S", "NODE", vmin=100001, vmax=100004)
mapdl.d("ALL", "UX", 0)
mapdl.d("ALL", "UY", 0)
mapdl.d("ALL", "UZ", -0.6001)  # 0.1 gap
mapdl.allsel()

# keyopts
mapdl.keyopt("CONT", 7, 1)

# finish
mapdl.finish()
mapdl.run("/SOLU")
mapdl.antype("static")

# Activate non-linear geometry
mapdl.nlgeom("on")

# Request substeps
mapdl.autots(key="on")
mapdl.nsubst(nsbstp=100, nsbmx=100, nsbmn=100)
mapdl.kbc(key=0)
mapdl.outres("all", "all")

# Solve
output = mapdl.solve()
print(output)
result = mapdl.result
#mapdl.open_gui()
